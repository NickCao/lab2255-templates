kind: ClusterTask
apiVersion: tekton.dev/v1beta1
metadata:
  name: tag-image
spec:
  description: Nothing to do
  params:
    - default: ""
      description: URL of the image to be copied to the destination registry
      name: source-image
      type: string
    - default: ""
      description: URL of the image where the image from source should be copied to
      name: target-image
      type: string
  steps:
    - name: tag-image
      image: quay.io/skopeo/stable:latest
      env:
        - name: HOME
          value: /tekton/home
      resources: {}
      script: |
        #!/usr/bin/env bash

        ls -la /workspace/dockerconfig
        cat /workspace/dockerconfig/config.json

        skopeo copy --dest-creds=$(cat /workspace/dockerconfig/config.json) ${source-image} ${target-image}

        #skopeo copy docker://${source-image} docker://${target-image}

      securityContext:
        runAsNonRoot: true
        runAsUser: 65532

      volumeMounts:
        - mountPath: /var/lib/containers
          name: dockerconfig
  workspaces:
    - name: dockerconfig
      description: Includes a docker `config.json`
      optional: true
