kind: Task
apiVersion: tekton.dev/v1beta1
metadata:
  name: aib-builder-task
spec:
  params:
    - name: revision
      description: 'Revision to checkout. (branch, tag, sha, ref, etc...)'
      type: string
      default: ''
    - name: secret-config-ref
      description: Bla bla
      type: string
      default: 'aib-config'
  steps:
    - name: aib-build
      image: quay.io/agnosticd/ee-multicloud:latest
      env:
        - name: AIB_USER
          valueFrom:
            secretKeyRef:
              key: user
              name: $(params.secret-config-ref)
        - name: AIB_PASSWORD
          valueFrom:
            secretKeyRef:
              key: password
              name: $(params.secret-config-ref)
        - name: AIB_HOST
          valueFrom:
            secretKeyRef:
              key: host
              name: $(params.secret-config-ref)
      script: |
        #!/usr/bin/env bash

        set -x

        export ANSIBLE_HOST_KEY_CHECKING=False

        export REVISION="$(params.revision)"

        ansible-playbook /scripts/builder.yaml -i $AIB_HOST, -e "ansible_user=$AIB_USER" -e "ansible_password=$AIB_PASSWORD" 

      volumeMounts: 
        - name: scripts-volume
          mountPath: /scripts
  volumes:
    - name: scripts-volume
      configMap:
        name: {{ .Values.app.name }}-ansible-scripts
        items:
          - key: builder.yaml
            path: builder.yaml
  workspaces:
    - name: source